name: Swift CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: swift-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pr_tests:
    name: PR Â· Tests (matrix)
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        os: [ macos-14, macos-15 ]
        swift: [ "6.1", "6.2" ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift (${{ matrix.swift }})
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-swiftpm-${{ matrix.swift }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swiftpm-${{ matrix.swift }}-
            ${{ runner.os }}-swiftpm-

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ§ª Running tests (no coverage)â€¦"
          swift test --parallel 2>&1 | tee test_output.txt

          # Best-effort test count (XCTest usually prints: "Executed N tests")
          TEST_COUNT=$(grep -Eo "Executed[[:space:]]+[0-9]+[[:space:]]+tests" test_output.txt | grep -Eo "[0-9]+" | tail -1 || true)
          TEST_COUNT=${TEST_COUNT:-0}
          echo "ðŸ“Š Test count: $TEST_COUNT"

      - name: Create summary
        if: always()
        shell: bash
        run: |
          {
            echo "## PR Tests"
            echo "- OS: ${{ matrix.os }}"
            echo "- Swift: ${{ matrix.swift }}"
            echo "- Result: ${{ job.status }}"
          } >> "$GITHUB_STEP_SUMMARY"

  main_coverage_gate:
    name: Main Â· Coverage gate (matrix)
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: true
      matrix:
        include:
          # Primary combo: this one enforces the coverage threshold (gate)
          - os: macos-15
            swift: "6.2"
            primary: true
          # Additional combos: run coverage + artifacts for visibility, but do not gate
          - os: macos-15
            swift: "6.1"
            primary: false
          - os: macos-14
            swift: "6.2"
            primary: false
          - os: macos-14
            swift: "6.1"
            primary: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift (${{ matrix.swift }})
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ matrix.swift }}

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-swiftpm-${{ matrix.swift }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swiftpm-${{ matrix.swift }}-
            ${{ runner.os }}-swiftpm-

      - name: Run tests with coverage
        id: tests
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ§ª Running tests with coverageâ€¦"
          swift test --enable-code-coverage --parallel 2>&1 | tee test_output.txt

          TEST_COUNT=$(grep -Eo "Executed[[:space:]]+[0-9]+[[:space:]]+tests" test_output.txt | grep -Eo "[0-9]+" | tail -1 || true)
          TEST_COUNT=${TEST_COUNT:-0}

          echo "test_count=$TEST_COUNT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š Test count: $TEST_COUNT"

      - name: Locate coverage profdata
        id: coverage
        shell: bash
        run: |
          set -euo pipefail

          PROFDATA=$(find .build -name "default.profdata" -print -quit 2>/dev/null || true)
          if [ -z "${PROFDATA}" ]; then
            PROFDATA=$(find .build -name "*.profdata" -print -quit 2>/dev/null || true)
          fi

          if [ -z "${PROFDATA}" ]; then
            echo "âŒ No coverage profdata found in .build"
            find .build -type f -name "*.profdata" -maxdepth 6 2>/dev/null || true
            exit 1
          fi

          echo "profdata=$PROFDATA" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š profdata: $PROFDATA"

      - name: Locate test binary
        id: binary
        shell: bash
        run: |
          set -euo pipefail

          TEST_BINARY=$(find .build -path "*.xctest/Contents/MacOS/*" -type f -perm +111 -print -quit 2>/dev/null || true)

          if [ -z "${TEST_BINARY}" ]; then
            TEST_BINARY=$(find .build -type f -perm +111 -name "*Tests" 2>/dev/null | grep -v "\.dSYM" | head -1 || true)
          fi

          if [ -z "${TEST_BINARY}" ]; then
            echo "âŒ Test binary not found"
            echo "Top executables in .build:" 
            find .build -type f -perm +111 2>/dev/null | head -20 || true
            exit 1
          fi

          echo "binary=$TEST_BINARY" >> "$GITHUB_OUTPUT"
          echo "ðŸ§ª Test binary: $TEST_BINARY"

      - name: Generate coverage report
        id: cov
        shell: bash
        run: |
          set -euo pipefail

          PROFDATA="${{ steps.coverage.outputs.profdata }}"
          TEST_BINARY="${{ steps.binary.outputs.binary }}"

          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            ARCH_FLAG="-arch arm64"
          else
            ARCH_FLAG="-arch x86_64"
          fi

          IGNORE_REGEX='.*Tests.*|.*Version\\.swift|.*EKNetworkVersion\\.swift|.*ProgressSessionManager\\.swift'

          xcrun llvm-cov export \
            $ARCH_FLAG \
            -instr-profile "$PROFDATA" \
            -ignore-filename-regex="$IGNORE_REGEX" \
            -format="json" \
            "$TEST_BINARY" \
            > coverage.json

          xcrun llvm-cov show \
            $ARCH_FLAG \
            -instr-profile "$PROFDATA" \
            -ignore-filename-regex="$IGNORE_REGEX" \
            -format=text \
            "$TEST_BINARY" \
            > coverage_report.txt

      - name: Calculate coverage
        id: calc
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -s coverage.json ]; then
            echo "âŒ coverage.json not found or empty"
            exit 1
          fi

          COVERED=$(python3 -c "import json; d=json.load(open('coverage.json')); l=d['data'][0]['totals']['lines']; print(int(l.get('covered',0)))")
          TOTAL=$(python3 -c "import json; d=json.load(open('coverage.json')); l=d['data'][0]['totals']['lines']; print(int(l.get('count',0)))")
          COVERAGE=$(python3 -c "import json; d=json.load(open('coverage.json')); l=d['data'][0]['totals']['lines']; c=int(l.get('covered',0)); t=int(l.get('count',0)); print(f'{(c*100.0/t):.2f}' if t else '0.00')")
          COVERAGE_INT=${COVERAGE%.*}

          echo "covered=$COVERED" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "coverage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "coverage_int=$COVERAGE_INT" >> "$GITHUB_OUTPUT"

          echo ""
          echo "âœ… Code Coverage Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "OS:             ${{ matrix.os }}"
          echo "Swift:          ${{ matrix.swift }}"
          echo "Total lines:    $TOTAL"
          echo "Covered lines:  $COVERED"
          echo "Coverage:       ${COVERAGE}%"
          echo "Primary (gate): ${{ matrix.primary }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check coverage threshold (primary only)
        if: ${{ matrix.primary }}
        shell: bash
        run: |
          set -euo pipefail

          COVERAGE_INT="${{ steps.calc.outputs.coverage_int }}"
          COVERAGE="${{ steps.calc.outputs.coverage }}"

          if [ "$COVERAGE_INT" -lt 98 ]; then
            echo "âŒ Code coverage is ${COVERAGE}%, but required minimum is 98%"
            exit 1
          fi

          echo "âœ… Code coverage is ${COVERAGE}% (meets 98% requirement)"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.os }}-swift-${{ matrix.swift }}
          path: |
            coverage_report.txt
            coverage.json
          retention-days: 30

      - name: Create summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Main Coverage"
            echo "- OS: ${{ matrix.os }}"
            echo "- Swift: ${{ matrix.swift }}"
            echo "- Primary (gate): ${{ matrix.primary }}"
            echo "- Tests: ${{ steps.tests.outputs.test_count }}"
            echo "- Coverage: ${{ steps.calc.outputs.coverage }}% (${{ steps.calc.outputs.covered }}/${{ steps.calc.outputs.total }} lines)"
            echo "- Result: ${{ job.status }}"
          } >> "$GITHUB_STEP_SUMMARY"
